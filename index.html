<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Foursquare Leaderboard</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #343a40;
    }

    .badge {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 20px;
      white-space: nowrap;
    }

    .badge-moderator {
      background-color: #f2f2f2;
      color: black;
    }

    .badge-gold {
      background-color: gold;
      color: white;
    }

    .badge-silver {
      background-color: silver;
      color: white;
    }

    .badge-bronze {
      background-color: #cd7f32;
      color: white;
    }

    #leaderboard-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      animation: fadeIn 1s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    #leaderboard {
      width: 100%;
      border-collapse: collapse;
    }

    #leaderboard th,
    #leaderboard td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }

    #leaderboard th {
      background-color: #f2f2f2;
    }

    .action-btn {
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .action-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .action-btn:hover {
      background-color: #0056b3;
    }

    .loading {
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animate {
      animation: scaleUp 0.5s ease;
    }

    @keyframes scaleUp {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }

    .cool-message {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      font-weight: bold;
    }

    .banned-message {
      display: none;
    }

    .mobile-warning {
      display: none;
    }

    @media (max-width: 768px) {
      .mobile-warning {
        display: block;
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
      }
    }

    .vote-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .vote-controls button {
      margin: 0 5px;
    }

    .rank-change {
      font-size: 12px;
      color: #28a745;
      font-weight: bold;
    }

    .animate-fade {
      animation: animateFade 1s ease;
    }

    @keyframes animateFade {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }

    .error-message {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #dc3545;
      color: #fff;
      border-radius: 5px;
      font-weight: bold;
    }

    .account-btn {
      display: block;
      margin: 20px auto;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .account-btn:hover {
      background-color: #0056b3;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script src="https://foursquare-leaderboard.web.app/messaging.js"></script>
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <h1>Foursquare Leaderboard</h1>
  <button class="account-btn" onclick="openAccount()">Account</button>
  <div id="leaderboard-container">
    <table id="leaderboard">
      <thead>
        <tr>
          <th>Name</th>
          <th>Upvotes</th>
          <th>Downvotes</th>
          <th>Rank</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>
    <div class="vote-controls">
      <button class="action-btn refresh-btn" onclick="checkBanned(refreshLeaderboard)">
        Refresh Leaderboard
      </button>
      <button class="action-btn mod-btn" onclick="checkBanned(openMod)">
        Open Mod
      </button>
      <button class="action-btn featuresend-btn" onclick="checkBanned(requestFeature)">
        Open Sing Developments
      </button>
    </div>
  </div>
  <div class="cool-message">
    ©️ Sing Developments<br />
    Please do not vote for yourself and/or incessantly upvote or downvote a user for a reason not based on skill. Use upvote/downvote for requesting a progress/demotion in rank.
  </div>
  <div class="mobile-warning">
    We detected that you are on mobile. Please consider using a larger screen for a better experience.
  </div>
  <div class="error-message" id="errorMessage" style="display: none">
    Error: Failed to load leaderboard data.
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBPrsBIPdDSAdakt3S9yd2a83Mt6a0O4Qg",
      authDomain: "foursquare-leaderboard.firebaseapp.com",
      databaseURL: "https://foursquare-leaderboard-default-rtdb.firebaseio.com",
      projectId: "foursquare-leaderboard",
      storageBucket: "foursquare-leaderboard.appspot.com",
      messagingSenderId: "294979396523",
      appId: "1:294979396523:web:fe702a507d703a63ff37df"
    };

    firebase.initializeApp(firebaseConfig);

    const refreshTimes = [];
    const voteTimes = [];

    async function collectUserData() {
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          const userData = {
            uid: user.uid,
            email: user.email
          };
          Swal.fire({
            icon: 'success',
            title: 'Welcome Back!',
            text: `Welcome back, ${user.email}!`,
            confirmButtonText: 'OK'
          });
        } else {
          promptForLogin();
        }
      });
    }

    async function promptForLogin() {
      const { value: formValues, dismiss: dismissReason } = await Swal.fire({
        title: 'Login or Signup',
        html:
          '<input id="swal-input1" class="swal2-input" placeholder="Email" type="email">' +
          '<input id="swal-input2" class="swal2-input" placeholder="Password" type="password">',
        focusConfirm: false,
        allowOutsideClick: false,
        showCloseButton: false, // Disable the close button
        allowEscapeKey: false,   // Disable closing with Escape key
        preConfirm: () => {
          return [
            document.getElementById('swal-input1').value,
            document.getElementById('swal-input2').value
          ]
        },
        showCancelButton: true,
        cancelButtonText: 'Sign Up',
        confirmButtonText: 'Login'
      });

      if (formValues) {
        const [email, password] = formValues;

        if (!email || !password) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'All fields are required.',
          });
          return promptForLogin();
        }

        try {
          const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
        } catch (error) {
          if (error.code === 'auth/user-not-found') {
            const { value: name } = await Swal.fire({
              title: 'Signup',
              input: 'text',
              inputPlaceholder: 'Enter your name',
              showCancelButton: true,
              inputValidator: (value) => {
                if (!value) {
                  return 'You need to write something!';
                }
              }
            });

            if (name) {
              try {
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await saveUserData(user.uid, email, name);
              } catch (signUpError) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Failed to sign up. Please try again.',
                });
                return promptForLogin();
              }
            } else {
              return promptForLogin();
            }
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to login. Please check your credentials.',
            });
            return promptForLogin();
          }
        }
      } else if (dismissReason === Swal.DismissReason.cancel) {
        promptForSignup();
      } else if (dismissReason === Swal.DismissReason.esc) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Nice Try',
        });
        return promptForLogin();
      }
    }

    async function promptForSignup() {
      const { value: formValues, dismiss: dismissReason } = await Swal.fire({
        title: 'Signup',
        html:
          '<input id="swal-input1" class="swal2-input" placeholder="Email" type="email">' +
          '<input id="swal-input2" class="swal2-input" placeholder="Password" type="password">',
        focusConfirm: false,
        allowOutsideClick: false,
        showCloseButton: false, // Disable the close button
        allowEscapeKey: false,   // Disable closing with Escape key
        preConfirm: () => {
          return [
            document.getElementById('swal-input1').value,
            document.getElementById('swal-input2').value
          ]
        },
        showCancelButton: true,
        cancelButtonText: 'Cancel',
        confirmButtonText: 'Sign Up'
      });

      if (formValues) {
        const [email, password] = formValues;

        if (!email || !password) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'All fields are required.',
          });
          return promptForSignup();
        }

        try {
          const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;

          const { value: name } = await Swal.fire({
            title: 'Signup',
            input: 'text',
            inputPlaceholder: 'Enter your name',
            showCancelButton: true,
            inputValidator: (value) => {
              if (!value) {
                return 'You need to write something!';
              }
            }
          });

          if (name) {
            await saveUserData(user.uid, email, name);
          } else {
            return promptForSignup();
          }
        } catch (signUpError) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to sign up. Please try again.',
          });
          return promptForSignup();
        }
      } else if (dismissReason === Swal.DismissReason.cancel) {
        promptForLogin();
      } else if (dismissReason === Swal.DismissReason.esc) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Nice Try',
        });
        return promptForSignup();
      }
    }

    async function saveUserData(uid, email, name) {
      await firebase.database().ref(`users/${uid}`).set({
        uid,
        email,
        name
      });

      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: `Thank you, ${name}! Your data has been saved.`,
      }).then(() => {
        document.getElementById("loading").style.display = "none";
      });
    }

    async function checkBanned(action) {
      try {
        document.getElementById("loading").style.display = "block";
        const user = firebase.auth().currentUser;
        if (!user) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'You need to be logged in to perform this action.',
          });
          return;
        }

        const bannedRef = firebase.database().ref(`banned/${user.uid}`);
        const snapshot = await bannedRef.once('value');
        const currentTime = Date.now();

        if (snapshot.exists()) {
          const banData = snapshot.val();
          if (currentTime < banData.unbanTime) {
            Swal.fire({
              icon: 'error',
              title: 'Banned',
              text: `You have been banned from performing this action until ${new Date(banData.unbanTime).toLocaleString()}.`
            }).then(() => {
              document.getElementById("loading").style.display = "none";
            });
            return;
          } else {
            await bannedRef.remove();
          }
        }

        action();
        document.getElementById("loading").style.display = "none";
      } catch (error) {
        console.error('Error checking ban status:', error);
        document.getElementById("loading").style.display = "none";
      }
    }

    async function trackAction(timesArray, action, details) {
      const currentTime = Date.now();
      timesArray.push(currentTime);

      // Remove actions older than 1 minute
      const oneMinuteAgo = currentTime - 60000;
      timesArray = timesArray.filter(time => time > oneMinuteAgo);

      if (timesArray.length > 5) {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const bannedRef = firebase.database().ref(`banned/${user.uid}`);
        await bannedRef.set({
          banTime: currentTime,
          unbanTime: currentTime + 86400000 // 24 hour ban
        });

        Swal.fire({
          icon: 'error',
          title: 'Banned',
          text: 'You have been banned from performing actions for 24 hours due to excessive activity.'
        });

        timesArray.length = 0; // Clear the array
      }

      logAction(action, details);
    }

    async function logAction(action, details) {
      const user = firebase.auth().currentUser;
      if (!user) return;

      const actionRef = firebase.database().ref(`actions/${user.uid}`).push();
      await actionRef.set({
        action,
        details,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function fetchLeaderboard() {
      document.getElementById("loading").style.display = "block";
      firebase.database().ref("leaderboard").once("value", (snapshot) => {
        const leaderboardData = snapshot.val();
        updateLeaderboardTable(leaderboardData);
        document.getElementById("loading").style.display = "none";
      }).catch((error) => {
        console.error("Error fetching leaderboard data: ", error);
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("loading").style.display = "none";
      });
    }

    function updateLeaderboardTable(data) {
      const tableBody = document.querySelector("#leaderboard tbody");
      tableBody.innerHTML = "";
      const sortedData = Object.entries(data).sort((a, b) => a[1].rank - b[1].rank).slice(0, 20);
      sortedData.forEach(([id, entry], index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.name} ${getBadge(entry.name, entry.rank)}</td>
          <td>${entry.upvotes}</td>
          <td>${entry.downvotes}</td>
          <td>${entry.rank}</td>
          <td>
            <button class="action-btn" onclick="checkBanned(() => castVote('${id}', 'upvote'))">Upvote</button>
            <button class="action-btn" onclick="checkBanned(() => castVote('${id}', 'downvote'))">Downvote</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function castVote(userId, voteType) {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to vote.',
        });
        return;
      }

      trackAction(voteTimes, `castVote-${voteType}`, { userId, voteType });
      const userRef = firebase.database().ref(`leaderboard/${userId}`);
      userRef.transaction((user) => {
        if (user) {
          if (voteType === "upvote") {
            user.upvotes = (user.upvotes || 0) + 1;
          } else if (voteType === "downvote") {
            user.downvotes = (user.downvotes || 0) + 1;
          }
        }
        return user;
      }).then(() => {
        fetchLeaderboard();
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: `Vote ${voteType}d successfully.`,
        });
      }).catch((error) => {
        console.error("Error casting vote: ", error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to cast vote.',
        });
      });
    }

    function refreshLeaderboard() {
      trackAction(refreshTimes, 'refreshLeaderboard', {});
      fetchLeaderboard();
      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Leaderboard refreshed successfully.',
      });
    }

    function openMod() {
      trackAction(voteTimes, 'openMod', {});
      // Directly redirect to mod.html
      window.location.href = 'mod.html';
    }

    function requestFeature() {
      trackAction(voteTimes, 'requestFeature', {});
      // Directly redirect to mod.html
      window.location.href = 'https://singdev.wixsite.com/sing-developments';
    }

    function openAccount() {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to access your account.',
        });
        return;
      }

      firebase.database().ref(`users/${user.uid}`).once('value', (snapshot) => {
        const userData = snapshot.val();
        Swal.fire({
          title: 'Account',
          html: `
            <p>Name: ${userData.name}</p>
            <p>Email: ${user.email}</p>
            <button class="action-btn" onclick="logout()">Logout</button>
            <button class="action-btn" onclick="resetPassword()">Reset Password</button>
            <button class="action-btn" onclick="showHistory()">Show History</button>
            <button class="action-btn" onclick="Swal.close()">Close</button>
          `,
          showConfirmButton: false
        });
      });
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Logged Out',
          text: 'You have been logged out successfully.',
        }).then(() => {
          window.location.reload();
        });
      }).catch((error) => {
        console.error('Error logging out:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to log out. Please try again.',
        });
      });
    }

    function resetPassword() {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to reset your password.',
        });
        return;
      }

      firebase.auth().sendPasswordResetEmail(user.email).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Password Reset',
          text: 'A password reset email has been sent to your email address.',
        });
      }).catch((error) => {
        console.error('Error sending password reset email:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to send password reset email. Please try again.',
        });
      });
    }

    function showHistory() {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to view your history.',
        });
        return;
      }

      firebase.database().ref(`actions/${user.uid}`).once('value', (snapshot) => {
        const actions = snapshot.val();
        if (!actions) {
          Swal.fire({
            icon: 'info',
            title: 'No History',
            text: 'You have no actions recorded.',
          });
          return;
        }

        const actionList = Object.entries(actions).map(([key, action]) => ({
          id: key,
          ...action
        })).sort((a, b) => b.timestamp - a.timestamp);

        let historyHtml = '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th>Action</th><th>Details</th><th>Timestamp</th></tr></thead><tbody>';
        actionList.forEach(action => {
          historyHtml += `<tr><td>${action.action}</td><td>${JSON.stringify(action.details)}</td><td>${new Date(action.timestamp).toLocaleString()}</td></tr>`;
        });
        historyHtml += '</tbody></table>';

        Swal.fire({
          title: 'Action History',
          html: historyHtml,
          showConfirmButton: true,
          confirmButtonText: 'Close'
        });
      });
    }

    function getBadge(name, rank) {
      let badges = "";
      if (name === "Silas") {
        badges += '<span class="badge badge-moderator">Admin</span>';
      } else if (name === "Jude" || name === "Ruth" || name === "Miriam" || name === "Reed" || name === "Walter") {
        badges += '<span class="badge badge-moderator">Moderator</span>';
      }
      if (rank === 1) {
        badges += '<span class="badge badge-gold">1</span>';
      } else if (rank === 2) {
        badges += '<span class="badge badge-silver">2</span>';
      } else if (rank === 3) {
        badges += '<span class="badge badge-bronze">3</span>';
      }
      return badges;
    }

    collectUserData();
    fetchLeaderboard();
  </script>
</body>
</html>
