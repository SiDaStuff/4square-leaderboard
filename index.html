<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Foursquare Leaderboard</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <link rel="stylesheet" href="https://foursquare-leaderboard.web.app/index.css" />
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script src="https://foursquare-leaderboard.web.app/messaging.js"></script>
  <!-- Google AdSense script -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1039494559645682" crossorigin="anonymous"></script>
  <script async src="https://fundingchoicesmessages.google.com/i/pub-1039494559645682?ers=1" nonce="UL83oSpcLDQv7rOogHcJyA"></script>
  <script nonce="UL83oSpcLDQv7rOogHcJyA">
    (function () {
      function signalGooglefcPresent() {
        if (!window.frames["googlefcPresent"]) {
          if (document.body) {
            const iframe = document.createElement("iframe");
            iframe.style = "width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;";
            iframe.style.display = "none";
            iframe.name = "googlefcPresent";
            document.body.appendChild(iframe);
          } else {
            setTimeout(signalGooglefcPresent, 0);
          }
        }
      }
      signalGooglefcPresent();
    })();
  </script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <!-- End Google AdSense script -->
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <h1>Foursquare Leaderboard</h1>
  <div id="leaderboard-container">
    <table id="leaderboard">
      <thead>
        <tr>
          <th>Name</th>
          <th>Upvotes</th>
          <th>Downvotes</th>
          <th>Rank</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <!-- Google AdSense Ad Placement -->
    <ins class="adsbygoogle" style="display: block" data-ad-client="ca-pub-1039494559645682" data-ad-slot="4252978616" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    <!-- End Google AdSense Ad Placement -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>
    <div class="vote-controls">
      <button class="action-btn refresh-btn" onclick="checkBanned(refreshLeaderboard)">
        Refresh Leaderboard
      </button>
      <button class="action-btn mod-btn" onclick="checkBanned(openMod)">
        Open Mod
      </button>
      <button class="action-btn check-ip-btn" onclick="checkIp()">
        Check IP
      </button>
      <button class="action-btn featuresend-btn" onclick="checkBanned(requestFeature)">
        Request Feature/Report Bug
      </button>
    </div>
  </div>
  <div class="cool-message">
    ©️ Sing Developments<br />
    Please do not vote for yourself and/or incessantly upvote or downvote a user for a reason not based on skill. Use upvote/downvote for requesting a progress/demotion in rank.
  </div>
  <div class="mobile-warning">
    We detected that you are on mobile. Please consider using a larger screen for a better experience.
  </div>
  <div class="error-message" id="errorMessage" style="display: none">
    Error: Failed to load leaderboard data.
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBPrsBIPdDSAdakt3S9yd2a83Mt6a0O4Qg",
      authDomain: "foursquare-leaderboard.firebaseapp.com",
      databaseURL: "https://foursquare-leaderboard-default-rtdb.firebaseio.com",
      projectId: "foursquare-leaderboard",
      storageBucket: "foursquare-leaderboard.appspot.com",
      messagingSenderId: "294979396523",
      appId: "1:294979396523:web:fe702a507d703a63ff37df"
    };

    firebase.initializeApp(firebaseConfig);

    const refreshTimes = [];
    const voteTimes = [];

    async function getIpAddress() {
      const response = await fetch('https://api.ipify.org/?format=txt');
      return response.text();
    }

    async function collectUserData() {
      const ipAddress = (await getIpAddress()).replace(/\./g, '_');
      const userSnapshot = await firebase.database().ref(`users/${ipAddress}`).once('value');

      if (userSnapshot.exists()) {
        const userData = userSnapshot.val();
        Swal.fire({
          icon: 'success',
          title: 'Welcome Back!',
          text: `Welcome back, ${userData.firstname}!`,
          showCancelButton: true,
          confirmButtonText: 'OK',
          cancelButtonText: 'Change Name',
        }).then((result) => {
          if (result.dismiss === Swal.DismissReason.cancel) {
            promptForName();
          }
        });
      } else {
        promptForName();
      }
    }

    async function promptForName() {
  const { value: formValues, dismiss: dismissReason } = await Swal.fire({
    title: 'Enter your legal name',
    html:
      '<input id="swal-input1" class="swal2-input" placeholder="First name">' +
      '<input id="swal-input2" class="swal2-input" placeholder="Last name">' +
      '<div>Incorrect Data may lead to getting banned</div>',
    focusConfirm: false,
    allowOutsideClick: false,
    showCloseButton: false, // Disable the close button
    allowEscapeKey: false,   // Disable closing with Escape key
    preConfirm: () => {
      return [
        document.getElementById('swal-input1').value,
        document.getElementById('swal-input2').value
      ]
    }
  });

  if (formValues) {
    const [firstname, lastname] = formValues;

    if (!firstname || !lastname) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Both fields are required.',
      });
      return promptForName();
    }

    await saveUserData(firstname, lastname);
  } else if (dismissReason === Swal.DismissReason.esc) {
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Nice Try',
      });
      return promptForName();
    console.log('Escape key press detected');
  }
}


    async function saveUserData(firstname, lastname) {
      const ipAddress = (await getIpAddress()).replace(/\./g, '_');
      await firebase.database().ref(`users/${ipAddress}`).set({
        firstname,
        lastname,
        ipaddress: ipAddress
      });

      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: `Thank you, ${firstname}! Your data has been saved.`,
      }).then(() => {
        document.getElementById("loading").style.display = "none";
      });
    }

    async function checkBanned(action) {
      try {
        document.getElementById("loading").style.display = "block";
        const ipAddress = (await getIpAddress()).replace(/\./g, '_'); // Encode the IP address
        const bannedRef = firebase.database().ref(`banned/${ipAddress}`);
        const snapshot = await bannedRef.once('value');
        const currentTime = Date.now();

        if (snapshot.exists()) {
          const banData = snapshot.val();
          if (currentTime < banData.unbanTime) {
            Swal.fire({
              icon: 'error',
              title: 'Banned',
              text: `You have been banned from performing this action until ${new Date(banData.unbanTime).toLocaleString()}.`
            }).then(() => {
              document.getElementById("loading").style.display = "none";
            });
            return;
          } else {
            await bannedRef.remove();
          }
        }

        action();
        document.getElementById("loading").style.display = "none";
      } catch (error) {
        console.error('Error checking ban status:', error);
        document.getElementById("loading").style.display = "none";
      }
    }

    async function trackAction(timesArray) {
      const currentTime = Date.now();
      timesArray.push(currentTime);

      // Remove actions older than 1 minute
      const oneMinuteAgo = currentTime - 60000;
      timesArray = timesArray.filter(time => time > oneMinuteAgo);

      if (timesArray.length > 5) {
        const ipAddress = (await getIpAddress()).replace(/\./g, '_'); // Encode the IP address
        const bannedRef = firebase.database().ref(`banned/${ipAddress}`);
        await bannedRef.set({
          banTime: currentTime,
          unbanTime: currentTime + 86400000 // 24 hour ban
        });

        Swal.fire({
          icon: 'error',
          title: 'Banned',
          text: 'You have been banned from performing actions for 24 hours due to excessive activity.'
        });

        timesArray.length = 0; // Clear the array
      }
    }

    async function checkIp() {
      try {
        const ipAddress = await getIpAddress();
        Swal.fire({
          title: 'Your IP Address',
          text: `IP Address: ${ipAddress}`,
          icon: 'info',
          confirmButtonText: 'Close'
        });
      } catch (error) {
        console.error('Error retrieving IP address:', error);
        Swal.fire({
          title: 'Error',
          text: 'Failed to retrieve IP address.',
          icon: 'error',
          confirmButtonText: 'Close'
        });
      }
    }

    function fetchLeaderboard() {
      document.getElementById("loading").style.display = "block";
      firebase.database().ref("leaderboard").once("value", (snapshot) => {
        const leaderboardData = snapshot.val();
        updateLeaderboardTable(leaderboardData);
        document.getElementById("loading").style.display = "none";
      }).catch((error) => {
        console.error("Error fetching leaderboard data: ", error);
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("loading").style.display = "none";
      });
    }

    function updateLeaderboardTable(data) {
      const tableBody = document.querySelector("#leaderboard tbody");
      tableBody.innerHTML = "";
      const sortedData = Object.entries(data).sort((a, b) => a[1].rank - b[1].rank).slice(0, 20);
      sortedData.forEach(([id, entry], index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.name} ${getBadge(entry.name, entry.rank)}</td>
          <td>${entry.upvotes}</td>
          <td>${entry.downvotes}</td>
          <td>${entry.rank}</td>
          <td>
            <button class="action-btn" onclick="checkBanned(() => castVote('${id}', 'upvote'))">Upvote</button>
            <button class="action-btn" onclick="checkBanned(() => castVote('${id}', 'downvote'))">Downvote</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function castVote(userId, voteType) {
      trackAction(voteTimes);
      const userRef = firebase.database().ref(`leaderboard/${userId}`);
      userRef.transaction((user) => {
        if (user) {
          if (voteType === "upvote") {
            user.upvotes = (user.upvotes || 0) + 1;
          } else if (voteType === "downvote") {
            user.downvotes = (user.downvotes || 0) + 1;
          }
        }
        return user;
      }).then(() => {
        fetchLeaderboard();
      }).catch((error) => {
        console.error("Error casting vote: ", error);
      });
    }

    function refreshLeaderboard() {
      trackAction(refreshTimes);
      fetchLeaderboard();
    }

    function openMod() {
      // Directly redirect to mod.html
      window.location.href = 'mod.html';
    }

    function requestFeature() {
      // Directly redirect to mod.html
      window.location.href = 'feature-request.html';
    }

    function getBadge(name, rank) {
      let badges = "";
      if (name === "Silas") {
        badges += '<span class="badge badge-moderator">Admin</span>';
      } else if (name === "Jude" || name === "Ruth") {
        badges += '<span class="badge badge-moderator">Moderator</span>';
      }
      if (rank === 1) {
        badges += '<span class="badge badge-gold">1</span>';
      } else if (rank === 2) {
        badges += '<span class="badge badge-silver">2</span>';
      } else if (rank === 3) {
        badges += '<span class="badge badge-bronze">3</span>';
      }
      return badges;
    }

    collectUserData();
    fetchLeaderboard();
  </script>
</body>
</html>
