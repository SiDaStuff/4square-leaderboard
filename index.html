<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Foursquare Leaderboard</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      color: #343a40;
      overflow: auto; /* Ensure the body can scroll */
    }

    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
    }

    .content {
      position: relative;
      z-index: 1; /* Ensure content appears above the video */
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #343a40;
    }

    .badge {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 20px;
      white-space: nowrap;
      animation: pulse 1s infinite;
    }

    .badge-moderator {
      background-color: #f2f2f2;
      color: black;
    }

    .badge-bus {
      background-color: #FF6BBA;
      color: white;
    }

    .badge-gold {
      background-color: gold;
      color: white;
    }

    .badge-silver {
      background-color: silver;
      color: white;
    }

    .badge-bronze {
      background-color: #cd7f32;
      color: white;
    }

    .badge:hover {
      transform: scale(1.05);
    }

    .badge-featured {
      background-color: #ffd700;
      color: #333;
      border: 2px solid #cc9900;
      animation: pulse 1.5s infinite;
    }

    .badge-epic {
      background-color: #ff4500;
      color: white;
      border: 2px solid #cc3300;
      animation: glow 1.5s infinite;
    }

    .badge-legendary {
      background-color: #8a2be2;
      color: white;
      border: 2px solid #6a1b9a;
      animation: bounce 1.5s infinite;
    }

    .badge-mythic {
      background: linear-gradient(135deg, #14c5d6, #6beeff);
      color: white;
      border: 2px solid lightblue;
      animation: blueFlames 2s infinite, pulseGlow 1.5s ease-in-out infinite, rotateBadge 6s linear infinite;
      padding: 7px 14px; /* Adjusted padding */
      font-size: 0.8rem; /* Adjusted font size */
      font-weight: bold;
      text-transform: uppercase;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), 0 0 20px rgba(0, 255, 255, 0.4), 0 0 30px rgba(0, 255, 255, 0.2);
      border-radius: 8px; /* Adjusted border-radius */
      position: relative;
      z-index: 1;
      overflow: hidden;
    }

    .badge-mythic::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
      animation: flicker 4s infinite ease-in-out;
      z-index: -1;
      opacity: 0.5;
    }

    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), 0 0 30px rgba(0, 255, 255, 0.4), 0 0 50px rgba(0, 255, 255, 0.2);
      }
      50% {
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 0 0 40px rgba(0, 255, 255, 0.6), 0 0 70px rgba(0, 255, 255, 0.4);
      }
      100% {
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), 0 0 30px rgba(0, 255, 255, 0.4), 0 0 50px rgba(0, 255, 255, 0.2);
      }
    }

    @keyframes rotateBadge {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes blueFlames {
      0% {
        background: linear-gradient(135deg, #14c5d6, #6beeff);
      }
      50% {
        background: linear-gradient(135deg, #0fa3b6, #5bd9ff);
      }
      100% {
        background: linear-gradient(135deg, #14c5d6, #6beeff);
      }
    }

    @keyframes flicker {
      0%, 100% {
        opacity: 0.5;
      }
      50% {
        opacity: 1;
      }
    }

    @keyframes glow {
      0% {
        box-shadow: 0 0 5px #ff4500;
      }
      50% {
        box-shadow: 0 0 15px #ff4500;
      }
      100% {
        box-shadow: 0 0 5px #ff4500;
      }
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }

    .badge-featured::before,
    .badge-epic::before,
    .badge-legendary::before {
      content: '';
      display: block;
      width: 100%;
      height: 5px;
      background: repeating-linear-gradient(
        45deg,
        #606dbc,
        #606dbc 10px,
        #465298 10px,
        #465298 20px
      );
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 5px 5px 0 0;
    }

    .badge-featured::after,
    .badge-epic::after,
    .badge-legendary::after {
      content: '';
      display: block;
      width: 100%;
      height: 5px;
      background: repeating-linear-gradient(
        45deg,
        #606dbc,
        #606dbc 10px,
        #465298 10px,
        #465298 20px
      );
      position: absolute;
      bottom: 0;
      left: 0;
      border-radius: 0 0 5px 5px;
    }

    .badge-featured,
    .badge-epic,
    .badge-legendary {
      position: relative;
      overflow: hidden;
    }

    #leaderboard-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      animation: fadeIn 1s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    #leaderboard {
      width: 100%;
      border-collapse: collapse;
    }

    #leaderboard th,
    #leaderboard td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }

    #leaderboard th {
      background-color: #f2f2f2;
    }

    .action-btn {
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .action-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .action-btn:hover {
      background-color: #0056b3;
    }

    .loading {
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animate {
      animation: scaleUp 0.5s ease;
    }

    @keyframes scaleUp {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }

    .cool-message {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      border-radius: 5px;
      font-weight: bold;
    }

    .banned-message {
      display: none;
    }

    .mobile-warning {
      display: none;
    }

    @media (max-width: 768px) {
      .mobile-warning {
        display: block;
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
      }
    }

    .vote-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .vote-controls button {
      margin: 0 5px;
    }

    .rank-change {
      font-size: 12px;
      color: #28a745;
      font-weight: bold;
    }

    .animate-fade {
      animation: animateFade 1s ease;
    }

    @keyframes animateFade {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }

    .error-message {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #dc3545;
      color: #fff;
      border-radius: 5px;
      font-weight: bold;
    }

    .account-btn {
      display: block;
      margin: 20px auto;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .account-btn:hover {
      background-color: #0056b3;
    }

    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    #search-bar {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 300px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    #search-bar:focus {
      border-color: #007bff;
      outline: none;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #fff;
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #888;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .footer {
      text-align: center;
      padding: 20px;
      background-color: #f8f9fa;
      border-top: 1px solid #ddd;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #007bff;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .notification.show {
      opacity: 1;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script src="https://foursquare-leaderboard.web.app/messaging.js"></script>
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <video autoplay muted loop id="bg-video">
    <source id="bg-source" src="" type="video/mp4">
    Your browser does not support HTML5 video.
  </video>
  <form autocomplete="off">
    <input type="text" style="display:none">
    <input type="password" style="display:none">
    <input type="text" id="none" name="none" placeholder="Search users..." oninput="filterLeaderboard()" autocomplete="off" aria-autocomplete="none" style="display:none">
  </form>

  <div class="sticky-header">
    <h1>Foursquare Leaderboard</h1>
    <button class="account-btn" onclick="openAccount()">Account</button>
  </div>
  <div id="leaderboard-container" class="custom-scrollbar">
    <div class="search-container">
      <form autocomplete="off">
        <input type="text" id="search-bar" name="search-bar" placeholder="Search users..." oninput="filterLeaderboard()" autocomplete="off" aria-autocomplete="none">
      </form>
    </div>
    <table id="leaderboard">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Upvotes</th>
          <th>Downvotes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>
    <div class="vote-controls">
      <button class="action-btn refresh-btn" onclick="checkBanned(refreshLeaderboard)">
        Refresh Leaderboard
      </button>
      <button class="action-btn mod-btn" onclick="checkBanned(openMod)">
        Open Mod
      </button>
      <button class="action-btn openSD-btn" onclick="checkBanned(openSD)">
        Open Sing Developments
      </button>
      <button class="action-btn openAPI" onclick="checkBanned(openAPI)">
        Open API Docs
      </button>
      <button class="action-btn openRules" onclick="checkBanned(openRules)">
        Open Official Rules
      </button>
    </div>
  </div>
  <div class="cool-message">
    ©️ Sing Developments<br />
    Please do not vote for yourself and/or incessantly upvote or downvote a user for a reason not based on skill. Use upvote/downvote for requesting a progress/demotion in rank.
  </div>
  <div class="mobile-warning">
    We detected that you are on mobile. Please consider using a larger screen for a better experience.
  </div>
  <div class="error-message" id="errorMessage" style="display: none">
    Error: Failed to load leaderboard data.
  </div>
  <div class="footer">
    ©️ Sing Developments 2023
  </div>
  <div class="notification" id="notification">Notification</div>

  <script>
    window.onload = function() {
      const videos = [
        'bg/1.mp4',
        'bg/2.mp4',
        'bg/3.mp4',
        'bg/4.mp4',
        'bg/5.mp4'
      ];
      const randomIndex = Math.floor(Math.random() * videos.length);
      const videoSource = document.getElementById('bg-source');
      videoSource.src = videos[randomIndex];
      document.getElementById('bg-video').load();
    };

    const firebaseConfig = {
      apiKey: "AIzaSyBPrsBIPdDSAdakt3S9yd2a83Mt6a0O4Qg",
      authDomain: "foursquare-leaderboard.firebaseapp.com",
      databaseURL: "https://foursquare-leaderboard-default-rtdb.firebaseio.com",
      projectId: "foursquare-leaderboard",
      storageBucket: "foursquare-leaderboard.appspot.com",
      messagingSenderId: "294979396523",
      appId: "1:294979396523:web:fe702a507d703a63ff37df"
    };

    firebase.initializeApp(firebaseConfig);

    const refreshTimes = [];
    const voteTimes = [];

    async function collectUserData() {
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          const userData = {
            uid: user.uid,
            email: user.email
          };
          Swal.fire({
            icon: 'success',
            title: 'Welcome Back!',
            text: `Welcome back, ${user.email}!`,
            confirmButtonText: 'OK'
          });
        } else {
          promptForLogin();
        }
      });
    }

    async function promptForLogin() {
      const { value: formValues, dismiss: dismissReason } = await Swal.fire({
        title: 'Login or Signup',
        html:
          '<input id="swal-input1" class="swal2-input" placeholder="Email" type="email" autocomplete="off">' +
          '<input id="swal-input2" class="swal2-input" placeholder="Password" type="password" autocomplete="off">',
        focusConfirm: false,
        allowOutsideClick: true,
        showCloseButton: true, // Disable the close button
        allowEscapeKey: true,   // Disable closing with Escape key
        preConfirm: () => {
          return [
            document.getElementById('swal-input1').value,
            document.getElementById('swal-input2').value
          ]
        },
        showCancelButton: true,
        cancelButtonText: 'Sign Up',
        confirmButtonText: 'Login'
      });

      if (formValues) {
        const [email, password] = formValues;

        if (!email || !password) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'All fields are required.',
          });
          return promptForLogin();
        }

        try {
          const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
        } catch (error) {
          if (error.code === 'auth/user-not-found') {
            const { value: name } = await Swal.fire({
              title: 'Signup',
              input: 'text',
              inputPlaceholder: 'Enter your name',
              showCancelButton: true,
              inputValidator: (value) => {
                if (!value) {
                  return 'You need to write something!';
                }
              }
            });

            if (name) {
              try {
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await saveUserData(user.uid, email, name);
              } catch (signUpError) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Failed to sign up. Please try again.',
                });
                return promptForLogin();
              }
            } else {
              return promptForLogin();
            }
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to login. Please check your credentials.',
            });
            return promptForLogin();
          }
        }
      } else if (dismissReason === Swal.DismissReason.cancel) {
        promptForSignup();
      } else if (dismissReason === Swal.DismissReason.esc) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Nice Try',
        });
        return promptForLogin();
      }
    }

    async function promptForSignup() {
      const { value: formValues, dismiss: dismissReason } = await Swal.fire({
        title: 'Signup',
        html:
          '<input id="swal-input1" class="swal2-input" placeholder="Email" type="email" autocomplete="off">' +
          '<input id="swal-input2" class="swal2-input" placeholder="Password" type="password" autocomplete="off">',
        focusConfirm: false,
        allowOutsideClick: true,
        showCloseButton: true, // Disable the close button
        allowEscapeKey: true,   // Disable closing with Escape key
        preConfirm: () => {
          return [
            document.getElementById('swal-input1').value,
            document.getElementById('swal-input2').value
          ]
        },
        showCancelButton: true,
        cancelButtonText: 'Cancel',
        confirmButtonText: 'Sign Up'
      });

      if (formValues) {
        const [email, password] = formValues;

        if (!email || !password) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'All fields are required.',
          });
          return promptForSignup();
        }

        try {
          const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;

          const { value: name } = await Swal.fire({
            title: 'Signup',
            input: 'text',
            inputPlaceholder: 'Enter your name',
            showCancelButton: true,
            inputValidator: (value) => {
              if (!value) {
                return 'You need to write something!';
              }
            }
          });

          if (name) {
            await saveUserData(user.uid, email, name);
          } else {
            return promptForSignup();
          }
        } catch (signUpError) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to sign up. Please try again.',
          });
          return promptForSignup();
        }
      } else if (dismissReason === Swal.DismissReason.cancel) {
        promptForLogin();
      } else if (dismissReason === Swal.DismissReason.esc) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Nice Try',
        });
        return promptForSignup();
      }
    }

    async function saveUserData(uid, email, name) {
      await firebase.database().ref(`users/${uid}`).set({
        uid,
        email,
        name
      });

      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: `Thank you, ${name}! Your data has been saved.`,
      }).then(() => {
        document.getElementById("loading").style.display = "none";
      });
    }

    async function checkBanned(action) {
      try {
        document.getElementById("loading").style.display = "block";
        const user = firebase.auth().currentUser;
        if (!user) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'You need to be logged in to perform this action.',
          });
          return;
        }

        const bannedRef = firebase.database().ref(`banned/${user.uid}`);
        const snapshot = await bannedRef.once('value');
        const currentTime = Date.now();

        if (snapshot.exists()) {
          const banData = snapshot.val();
          if (currentTime < banData.unbanTime) {
            Swal.fire({
              icon: 'error',
              title: 'Banned',
              text: `You have been banned from performing this action until ${new Date(banData.unbanTime).toLocaleString()}.`
            }).then(() => {
              document.getElementById("loading").style.display = "none";
            });
            return;
          } else {
            await bannedRef.remove();
          }
        }

        action();
        document.getElementById("loading").style.display = "none";
      } catch (error) {
        console.error('Error checking ban status:', error);
        document.getElementById("loading").style.display = "none";
      }
    }

    async function trackAction(timesArray, action, details) {
      const currentTime = Date.now();
      timesArray.push(currentTime);

      // Remove actions older than 1 minute
      const oneMinuteAgo = currentTime - 60000;
      timesArray = timesArray.filter(time => time > oneMinuteAgo);

      if (timesArray.length > 5) {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const bannedRef = firebase.database().ref(`banned/${user.uid}`);
        await bannedRef.set({
          banTime: currentTime,
          unbanTime: currentTime + 86400000 // 24 hour ban
        });

        Swal.fire({
          icon: 'error',
          title: 'Banned',
          text: 'You have been banned from performing actions for 24 hours due to excessive activity.'
        });

        timesArray.length = 0; // Clear the array
      }

      logAction(action, details);
    }

    async function logAction(action, details) {
      const user = firebase.auth().currentUser;
      if (!user) return;

      const actionRef = firebase.database().ref(`actions/${user.uid}`).push();
      await actionRef.set({
        action,
        details,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function fetchLeaderboard() {
      document.getElementById("loading").style.display = "block";
      firebase.database().ref("leaderboard").once("value", (snapshot) => {
        const leaderboardData = snapshot.val();
        updateLeaderboardTable(leaderboardData);
        document.getElementById("loading").style.display = "none";
      }).catch((error) => {
        console.error("Error fetching leaderboard data: ", error);
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("loading").style.display = "none";
      });
    }

    function updateLeaderboardTable(data) {
      const tableBody = document.querySelector("#leaderboard tbody");
      tableBody.innerHTML = "";
      const sortedData = Object.entries(data).sort((a, b) => a[1].rank - b[1].rank).slice(0, 20);

      sortedData.forEach(([id, entry], index) => {
        const row = document.createElement("tr");
        row.style.position = "relative"; // Ensure the row is positioned relative for the video background

        if (entry.badges?.mythic) {
          // Add mythic-specific styles
          row.classList.add('mythic-background');
          row.style.color = "white"; // Enforce white text for mythic rows
          row.style.fontWeight = "bold"; // Make text bold for visibility
          row.style.overflow = "hidden"; // Make sure the video is contained within the row

          row.innerHTML = `
            <td>${entry.rank}</td>
            <td>${entry.name} ${getBadge(entry.name, entry.rank)} ${getBadgeHtml(entry.badges || {})}</td>
            <td>${entry.upvotes}</td>
            <td>${entry.downvotes}</td>
            <td>
              <button class="action-btn tooltip" onclick="checkBanned(() => castVote('${id}', 'upvote'))">
                Upvote
                <span class="tooltiptext">Upvote this user</span>
              </button>
              <button class="action-btn tooltip" onclick="checkBanned(() => castVote('${id}', 'downvote'))">
                Downvote
                <span class="tooltiptext">Downvote this user</span>
              </button>
              <button class="action-btn tooltip" onclick="showDetails('${id}')">
                Details
                <span class="tooltiptext">Show Details</span>
              </button>
              ${getEditBadgeButton(id)}
            </td>
          `;

          // Add video background
          const video = document.createElement("video");
          video.src = "https://foursquare-leaderboard.web.app/mythic.mp4"; // Set the video source
          video.autoplay = true;
          video.loop = true;
          video.muted = true;
          video.style.position = "absolute";
          video.style.top = "0";
          video.style.left = "0";
          video.style.width = "100%";
          video.style.height = "100%";
          video.style.objectFit = "cover";
          video.style.zIndex = "-1"; // Ensure the video stays behind the content

          // Ensure the row has a higher stacking order than other table content
          row.style.position = "relative";
          row.style.zIndex = "1"; // Ensure the row content stays in front of the video
          row.appendChild(video);
        } else {
          row.innerHTML = `
            <td>${entry.rank}</td>
            <td>${entry.name} ${getBadge(entry.name, entry.rank)} ${getBadgeHtml(entry.badges || {})}</td>
            <td>${entry.upvotes}</td>
            <td>${entry.downvotes}</td>
            <td>
              <button class="action-btn tooltip" onclick="checkBanned(() => castVote('${id}', 'upvote'))">
                Upvote
                <span class="tooltiptext">Upvote this user</span>
              </button>
              <button class="action-btn tooltip" onclick="checkBanned(() => castVote('${id}', 'downvote'))">
                Downvote
                <span class="tooltiptext">Downvote this user</span>
              </button>
              <button class="action-btn tooltip" onclick="showDetails('${id}')">
                Details
                <span class="tooltiptext">Show Details</span>
              </button>
              ${getEditBadgeButton(id)}
            </td>
          `;
        }

        tableBody.appendChild(row);
      });
    }

    function castVote(userId, voteType) {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to vote.',
        });
        return;
      }

      trackAction(voteTimes, `castVote-${voteType}`, { userId, voteType });
      const userRef = firebase.database().ref(`leaderboard/${userId}`);
      userRef.transaction((user) => {
        if (user) {
          if (voteType === "upvote") {
            user.upvotes = (user.upvotes || 0) + 1;
          } else if (voteType === "downvote") {
            user.downvotes = (user.downvotes || 0) + 1;
          }
        }
        return user;
      }).then(() => {
        fetchLeaderboard();
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: `Vote ${voteType}d successfully.`,
        });
      }).catch((error) => {
        console.error("Error casting vote: ", error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to cast vote.',
        });
      });
    }

    function refreshLeaderboard() {
      trackAction(refreshTimes, 'refreshLeaderboard', {});
      fetchLeaderboard();
      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Leaderboard refreshed successfully.',
      });
    }

    function openMod() {
      trackAction(voteTimes, 'openMod', {});
      window.location.href = 'mod.html';
    }

    function openSD() {
      trackAction(voteTimes, 'openSD', {});
      // Directly redirect to Sing Developments
      window.location.href = 'https://singdev.wixsite.com/sing-developments';
    }

    function openRules() {
      trackAction(voteTimes, 'openRules', {});
      // Directly redirect to Sing Developments
      window.location.href = 'rules.html';
    }

    function openAPI() {
      trackAction(voteTimes, 'openAPI', {});
      window.location.href = 'apidocs.html';
    }

    function openAccount() {
      const user = firebase.auth().currentUser;
      if (!user) {
        promptForLogin();  // Call the function to prompt for login if user is not logged in
        return;
      }

      firebase.database().ref(`users/${user.uid}`).once('value', (snapshot) => {
        const userData = snapshot.val();
        Swal.fire({
          title: 'Account',
          html: `
            <p>Name: ${userData.name}</p>
            <p>Email: ${user.email}</p>
            <button class="action-btn" onclick="logout()">Logout</button>
            <button class="action-btn" onclick="resetPassword()">Reset Password</button>
            <button class="action-btn" onclick="showHistory()">Show History</button>
            <button class="action-btn" onclick="editProfile()">Edit Profile</button>
            <button class="action-btn" onclick="Swal.close()">Close</button>
          `,
          showConfirmButton: false
        });
      });
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Logged Out',
          text: 'You have been logged out successfully.',
        }).then(() => {
          window.location.reload();
        });
      }).catch((error) => {
        console.error('Error logging out:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to log out. Please try again.',
        });
      });
    }

    function resetPassword() {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to reset your password.',
        });
        return;
      }

      firebase.auth().sendPasswordResetEmail(user.email).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Password Reset',
          text: 'A password reset email has been sent to your email address.',
        });
      }).catch((error) => {
        console.error('Error sending password reset email:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to send password reset email. Please try again.',
        });
      });
    }

    function showHistory() {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to view your history.',
        });
        return;
      }

      firebase.database().ref(`actions/${user.uid}`).once('value', (snapshot) => {
        const actions = snapshot.val();
        if (!actions) {
          Swal.fire({
            icon: 'info',
            title: 'No History',
            text: 'You have no actions recorded.',
          });
          return;
        }

        const actionList = Object.entries(actions).map(([key, action]) => ({
          id: key,
          ...action
        })).sort((a, b) => b.timestamp - a.timestamp);

        let historyHtml = '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th>Action</th><th>Details</th><th>Timestamp</th></tr></thead><tbody>';
        actionList.forEach(action => {
          historyHtml += `<tr><td>${action.action}</td><td>${JSON.stringify(action.details)}</td><td>${new Date(action.timestamp).toLocaleString()}</td></tr>`;
        });
        historyHtml += '</tbody></table>';

        Swal.fire({
          title: 'Action History',
          html: historyHtml,
          showConfirmButton: true,
          confirmButtonText: 'Close'
        });
      });
    }

    function editProfile() {
      const user = firebase.auth().currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'You need to be logged in to edit your profile.',
        });
        return;
      }

      firebase.database().ref(`users/${user.uid}`).once('value', (snapshot) => {
        const userData = snapshot.val();
        Swal.fire({
          title: 'Edit Profile',
          html: `
            <input id="swal-input-name" class="swal2-input" placeholder="Name" value="${userData.name}">
            <input id="swal-input-email" class="swal2-input" placeholder="Email" value="${user.email}" disabled>
          `,
          focusConfirm: false,
          preConfirm: () => {
            return {
              name: document.getElementById('swal-input-name').value
            }
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const newName = result.value.name;
            firebase.database().ref(`users/${user.uid}`).update({ name: newName });
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: 'Profile updated successfully.',
            });
          }
        });
      });
    }

    function getBadge(name, rank) {
      let badges = "";
      if (name === "Silas") {
        badges += '<span class="badge badge-moderator">Admin</span>';
      } else if (name === "Jude" || name === "Miriam" || name === "Reed" || name === "Walter") {
        badges += '<span class="badge badge-moderator">Moderator</span>';
      }
      else if (name === "Izzy") {
        badges += '<span class="badge badge-bus">Official Bus Driver</span>';
      }
      if (rank === 1) {
        badges += '<span class="badge badge-gold">1</span>';
      } else if (rank === 2) {
        badges += '<span class="badge badge-silver">2</span>';
      } else if (rank === 3) {
        badges += '<span class="badge badge-bronze">3</span>';
      }
      return badges;
    }

    function getBadgeHtml(badges) {
      let badgeHtml = '';
      if (badges.featured) {
        badgeHtml += '<span class="badge badge-featured">Featured</span>';
      }
      if (badges.epic) {
        badgeHtml += '<span class="badge badge-epic">Epic</span>';
      }
      if (badges.legendary) {
        badgeHtml += '<span class="badge badge-legendary">Legendary</span>';
      }
      if (badges.mythic) {
        badgeHtml += '<span class="badge badge-mythic">Mythic</span>';
      }
      return badgeHtml;
    }

    function getEditBadgeButton(userId) {
      const user = firebase.auth().currentUser;
      if (user && user.uid === 'o548WLH1w3Qh0S2Yng5RtPYZWtS2') {
        return `<button class="action-btn tooltip" onclick="editBadges('${userId}')">
                  Edit Badges
                  <span class="tooltiptext">Edit Badges</span>
                </button>`;
      }
      return '';
    }

    function editBadges(userId) {
      const user = firebase.auth().currentUser;
      if (!user || user.uid !== 'o548WLH1w3Qh0S2Yng5RtPYZWtS2') {
        return;
      }

      firebase.database().ref(`leaderboard/${userId}`).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          const badges = userData.badges || {};
          Swal.fire({
            title: 'Edit Badges',
            html: `
              <div>
                <label>
                  <input type="checkbox" id="featured" ${badges.featured ? 'checked' : ''}>
                  Featured
                </label>
                <label>
                  <input type="checkbox" id="epic" ${badges.epic ? 'checked' : ''}>
                  Epic
                </label>
                <label>
                  <input type="checkbox" id="legendary" ${badges.legendary ? 'checked' : ''}>
                  Legendary
                </label>
                <label>
                  <input type="checkbox" id="mythic" ${badges.mythic ? 'checked' : ''}>
                  Mythic
                </label>
              </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Save',
            cancelButtonText: 'Cancel',
            preConfirm: () => {
              return {
                featured: document.getElementById('featured').checked,
                epic: document.getElementById('epic').checked,
                legendary: document.getElementById('legendary').checked,
                mythic: document.getElementById('mythic').checked
              };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const updatedBadges = result.value;
              firebase.database().ref(`leaderboard/${userId}/badges`).set(updatedBadges);
              fetchLeaderboard();
              Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Badges updated successfully.',
              });
            }
          });
        }
      });
    }

    function filterLeaderboard() {
      const filter = document.getElementById('search-bar').value.toLowerCase();
      const tableBody = document.querySelector("#leaderboard tbody");
      const rows = tableBody.getElementsByTagName("tr");

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let match = false;
        for (let j = 0; j < cells.length; j++) {
          if (cells[j].textContent.toLowerCase().includes(filter)) {
            match = true;
            break;
          }
        }
        rows[i].style.display = match ? "" : "none";
      }
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function showDetails(userId) {
      firebase.database().ref(`leaderboard/${userId}/rating`).once('value', (snapshot) => {
        const rating = snapshot.val();
        if (rating) {
          const accuracy = rating.accuracy || 0;
          const consistency = rating.consistency || 0;
          const engagement = rating.engagement || 0;
          const speed = rating.speed || 0;

          const accuracyImage = `<img src="https://foursquare-leaderboard.web.app/stars/${accuracy}.jpg" alt="Accuracy" style="width: 100px; height: auto;">`;
          const consistencyImage = `<img src="https://foursquare-leaderboard.web.app/stars/${consistency}.jpg" alt="Consistency" style="width: 100px; height: auto;">`;
          const engagementImage = `<img src="https://foursquare-leaderboard.web.app/stars/${engagement}.jpg" alt="Engagement" style="width: 100px; height: auto;">`;
          const speedImage = `<img src="https://foursquare-leaderboard.web.app/stars/${speed}.jpg" alt="Speed" style="width: 100px; height: auto;">`;

          Swal.fire({
            title: 'Rating',
            html: `
              <h3>Accuracy</h3>
              ${accuracyImage}
              <h3>Consistency</h3>
              ${consistencyImage}
              <h3>Engagement</h3>
              ${engagementImage}
              <h3>Speed</h3>
              ${speedImage}
              <div style="margin-top: 20px; text-align: center;">
                <button class="action-btn" onclick="showRatingCriteria()">Rating Criteria</button>
              </div>
            `,
            showConfirmButton: true,
            confirmButtonText: 'Close'
          });

        } else {
          Swal.fire({
            icon: 'info',
            title: 'No Rating',
            text: 'No rating data available for this user. Please contact Silas about this.',
          });
        }
      });
    }

    function showRatingCriteria() {
      Swal.fire({
        title: 'Rating Criteria',
        html: `
          <p>1. Speed – How quickly the player completes/returns the move.</p>
          <p>2. Accuracy – The average of how well the player gets the ball in the opponent's square.</p>
          <p>3. Consistency – How reliably the player keeps the same set of moves/roughly the same action towards a player.</p>
          <p>4. Engagement – How actively the player participates in the game weekly.</p>
        `,
        showConfirmButton: true,
        confirmButtonText: 'Close'
      });
    }

    collectUserData();
    fetchLeaderboard();
  </script>
</body>
</html>
