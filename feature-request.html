<!DOCTYPE html>
<html>
<head>
    <title>Leaderboard Feature Request</title>
    <link rel="icon" type="image/png" href="icon.png" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #feature-request-form, #requests-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: auto;
        }
        label {
            display: block;
            margin-bottom: 10px;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            color: #fff;
            background: #28a745;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #218838;
        }
        .request {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        .delete-button {
            color: #fff;
            background: #dc3545;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            float: right;
        }
        .delete-button:hover {
            background: #c82333;
        }
        .back-button {
            padding: 10px 20px;
            color: #fff;
            background: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .back-button:hover {
            background: #0056b3;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPrsBIPdDSAdakt3S9yd2a83Mt6a0O4Qg",
            authDomain: "foursquare-leaderboard.firebaseapp.com",
            databaseURL: "https://foursquare-leaderboard-default-rtdb.firebaseio.com",
            projectId: "foursquare-leaderboard",
            storageBucket: "foursquare-leaderboard.appspot.com",
            messagingSenderId: "294979396523",
            appId: "1:294979396523:web:0f14be10d99e3d6bf268ee",
            measurementId: "G-T6M8TSMP5M"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Function to get user's IP address
        async function getIpAddress() {
            const response = await fetch('https://api.ipify.org/?format=txt');
            return response.text();
        }

        // Function to check if user is banned and perform action if not banned
        async function checkBanned(action) {
            try {
                const ipAddress = await getIpAddress();
                const encodedIp = ipAddress.replace(/\./g, '_'); // Encode the IP address
                const bannedRef = firebase.database().ref(`banned/${encodedIp}`);
                const snapshot = await bannedRef.once('value');
                const currentTime = Date.now();

                if (snapshot.exists()) {
                    const banData = snapshot.val();
                    if (currentTime < banData.unbanTime) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Banned',
                            text: `You have been banned from performing this action until ${new Date(banData.unbanTime).toLocaleString()}.`
                        }).then(() => {
                            window.location.href = 'index.html'; // Redirect to index.html after showing ban alert
                        });
                        return;
                    } else {
                        await bannedRef.remove();
                    }
                }

                action();
            } catch (error) {
                console.error('Error checking ban status:', error);
            }
        }

        // Function to track actions and ban user if sending requests too frequently
        async function trackAction(timesArray) {
            const currentTime = Date.now();
            timesArray.push(currentTime);

            // Filter recent actions within the last 15 seconds
            const recentActions = timesArray.filter(time => currentTime - time <= 15000);

            // Check if more than 3 requests within 15 seconds
            if (recentActions.length > 3) {
                try {
                    const ipAddress = await getIpAddress();
                    const encodedIp = ipAddress.replace(/\./g, '_');
                    const unbanTime = currentTime + 24 * 60 * 60 * 1000; // 24 hours from now

                    await firebase.database().ref(`banned/${encodedIp}`).set({ unbanTime });

                    Swal.fire({
                        icon: 'error',
                        title: 'Banned',
                        text: `You have been banned for sending too many feature requests.`
                    }).then(() => {
                        window.location.href = 'index.html'; // Redirect to index.html after showing ban alert
                    });

                    return;
                } catch (error) {
                    console.error('Error banning user:', error);
                }
            }
        }

        // Function to submit feature request
        async function submitFeatureRequest() {
            await checkBanned(async () => {
                const request = document.getElementById('feature-request').value;
                const timestamp = new Date().toISOString();
                const ipAddress = await getIpAddress(); // Get user's IP address
                if (request.trim() !== "") {
                    await trackAction([]); // Track action before submitting request
                    const requestRef = firebase.database().ref('feature_requests').push();
                    await requestRef.set({
                        request: request,
                        timestamp: timestamp,
                        ip: ipAddress // Store IP address in Firebase
                    });
                    // Clear the form input field after successful submission
                    document.getElementById('feature-request').value = '';
                    alert('Feature request submitted successfully!');
                } else {
                    alert('Please enter a feature request before submitting.');
                }
            });
        }

        // Function to delete a feature request
        async function deleteFeatureRequest(id) {
            if (confirm('Are you sure you want to delete this request?')) {
                await firebase.database().ref('feature_requests/' + id).remove()
                    .then(() => {
                        loadFeatureRequests(); // Refresh the list after deletion
                    })
                    .catch((error) => {
                        console.error('Error deleting feature request:', error);
                    });
            }
        }

        // Function to load all feature requests
        function loadFeatureRequests() {
            database.ref('feature_requests').orderByChild('timestamp').once('value', (snapshot) => {
                const requestsContainer = document.getElementById('requests-container');
                requestsContainer.innerHTML = ''; // Clear existing requests
                const requests = [];
                snapshot.forEach((childSnapshot) => {
                    const request = childSnapshot.val();
                    requests.push({ ...request, id: childSnapshot.key });
                });
                requests.reverse().forEach((request) => {
                    const div = document.createElement('div');
                    div.className = 'request';
                    div.innerHTML = `<p>${request.timestamp} (${request.ip}): ${request.request} <button class="delete-button" onclick="deleteFeatureRequest('${request.id}')">Delete</button></p>`;
                    requestsContainer.appendChild(div);
                });
            }).catch((error) => {
                console.error('Error loading feature requests:', error);
            });
        }

        // Check URL for #admin and adjust content accordingly
        window.onload = () => {
            if (window.location.hash === '#admin') {
                document.getElementById('feature-request-form').style.display = 'none';
                document.getElementById('requests-container').style.display = 'block';
                loadFeatureRequests();
            } else {
                document.getElementById('feature-request-form').style.display = 'block';
                document.getElementById('requests-container').style.display = 'none';
            }
        }
    </script>
</head>
<body>
    <div id="feature-request-form">
        <h1>Leaderboard Feature Request/Bug Reports</h1>
        <form onsubmit="submitFeatureRequest(); return false;">
            <label for="feature-request">Feature Request/Bug Report:</label>
            <input type="text" id="feature-request" required>
            <button type="submit">Send</button>
        </form>
    </div>
    <div id="requests-container" style="display: none;">
        <h1>Submitted Feature Requests/Bug Reports</h1>
    </div>

    <!-- Back button to index.html -->
    <button class="back-button" onclick="window.location.href = 'index.html';">Home</button>
</body>
</html>
