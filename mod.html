<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foursquare Leaderboard Moderator Dashboard</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f3f3;
      margin: 0;
      padding: 0;
    }
    #dashboard {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1,
    h2 {
      text-align: center;
      color: #0073e6;
    }
    label {
      font-weight: bold;
    }
    input[type="text"],
    textarea,
    select {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.confirmButton {
      background-color: #0073e6;
      color: white;
    }
    button.confirmButton:hover {
      background-color: #66a3ff;
    }
    button.cancelButton {
      background-color: #ff0000;
      color: white;
    }
    button.cancelButton:hover {
      background-color: #ff6666;
    }
    .swal2-modal {
      width: 50% !important;
      max-width: 100% !important;
      margin: 0 !important;
      text-align: center !important;
    }
    .swal2-content {
      text-align: left;
    }
    .swal2-input,
    .swal2-select {
      text-align: center;
      margin: auto;
    }
    .swal2-textarea {
      resize: vertical;
      text-align: left;
    }
    #chatContainer {
      height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    #chatInput {
      width: calc(100% - 22px);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .chatMessage {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 5px;
      background-color: #e6f2ff;
      text-align: left;
    }
    #loadingIcon {
      text-align: center;
      margin-bottom: 10px;
    }
    .leaderboard-swal2-modal {
      width: 100vw !important;
      max-width: none !important;
      padding: 0 !important;
    }
    .ip-ban-swal2-modal {
      max-width: 3000px !important;
    }
    .ban-success-swal2-modal,
    .ban-error-swal2-modal {
      max-width: 3000px !important;
    }
    .users-swal2-modal {
      max-width: 3000px !important;
    }
    .swal2-input,
    .swal2-select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .swal2-textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      resize: vertical;
    }
    .approveButton {
      background-color: #4CAF50;
      color: white;
    }
    .approveButton:hover {
      background-color: #45a049;
    }
    .disapproveButton {
      background-color: #f44336;
      color: white;
    }
    .disapproveButton:hover {
      background-color: #e57373;
    }
    .approved {
      color: #4CAF50;
    }
    .disapproved {
      color: #f44336;
    }
    .refreshButton {
      background-color: #0073e6;
      color: white;
    }
    .refreshButton:hover {
      background-color: #66a3ff;
    }
  </style>
</head>
<body>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyBPrsBIPdDSAdakt3S9yd2a83Mt6a0O4Qg",
  authDomain: "foursquare-leaderboard.firebaseapp.com",
  databaseURL: "https://foursquare-leaderboard-default-rtdb.firebaseio.com",
  projectId: "foursquare-leaderboard",
  storageBucket: "foursquare-leaderboard.appspot.com",
  messagingSenderId: "294979396523",
  appId: "1:294979396523:web:0f14be10d99e3d6bf268ee",
  measurementId: "G-T6M8TSMP5M"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userIp;
    let userId;
    let userName;
    let userEmail;

    function loadPage() {
      fetch('https://api.ipify.org/?format=txt')
        .then(response => response.text())
        .then(ip => {
          userIp = ip;
          checkIpBan(ip)
            .then(isBanned => {
              if (isBanned) {
                window.close();
              } else {
                showLoginForm();
              }
            });
        })
        .catch(error => {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: `Failed to get IP address: ${error.message}`,
          });
        });
    }

    function showLoginForm() {
      Swal.fire({
        title: 'Login',
        html: `
          <label for="email">Email:</label><br>
          <input type="email" id="email" name="email" autocomplete="username" class="swal2-input"><br>
          <label for="password">Password:</label><br>
          <input type="password" id="password" name="password" autocomplete="current-password" class="swal2-input"><br>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Login',
        preConfirm: () => {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          return auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
              userId = userCredential.user.uid;
              userEmail = userCredential.user.email;
              return checkUserBan(userId);
            })
            .then(() => {
              return checkModeratorStatus(userId);
            })
            .then(() => {
              document.getElementById("dashboard").style.display = "block";
              document.getElementById("userIdDisplay").innerText = `User ID: ${userId}`;
              const currentDate = new Date();
              document.getElementById("dateTimeDisplay").innerText = `Current Date and Time: ${currentDate.toLocaleString()}`;
              setInterval(updateTime, 1000);
              readInfo();
              setInterval(refreshChat, 1000);
              getUserName(userId);
              setInterval(checkUserBanPeriodically, 1000);
            })
            .catch(error => {
              Swal.showValidationMessage(`${error.message}`);
            });
        }
      });
    }

    function checkUserBan(userId) {
      return db.ref(`banned/${userId}`).once('value')
        .then((snapshot) => {
          const banData = snapshot.val();
          if (banData && banData.unbanTime > new Date().getTime()) {
            throw new Error("Your account is banned.");
          }
          return userId;
        });
    }

    function checkUserBanPeriodically() {
      checkUserBan(userId).catch((error) => {
        location.reload();
      });
    }

    function checkModeratorStatus(userId) {
      return db.ref("modkeys").once("value")
        .then((snapshot) => {
          const keys = snapshot.val();
          if (!keys || !Object.values(keys).includes(userId)) {
            throw new Error("You are not a moderator.");
          }
          return userId;
        });
    }

    function getUserName(userId) {
      db.ref(`users/${userId}/name`).once('value')
        .then((snapshot) => {
          userName = snapshot.val();
        });
    }

    function updateTime() {
      const currentDate = new Date();
      document.getElementById("dateTimeDisplay").innerText = `Current Date and Time: ${currentDate.toLocaleString()}`;
    }

    function sendInfo() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        const name = document.getElementById("name").value;
        const suggestedRank = document.getElementById("suggestedRank").value;
        const detail = document.getElementById("detail").value;

        if (name && suggestedRank && detail && userId) {
          db.ref("mod")
            .push({
              name: name,
              suggestedRank: suggestedRank,
              detail: detail,
              userId: userId,
              ip: userIp,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
            })
            .then(() => {
              refreshInfoContainer();
              Swal.fire({
                icon: "success",
                title: "Success!",
                text: "Main info sent successfully.",
                confirmButtonText: "Close",
                allowOutsideClick: false,
                allowEscapeKey: false,
              });
            });
        } else {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Please fill in all fields.",
          });
        }
      });
    }

    function readInfo() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        const infoContainer = document.getElementById("infoContainer");
        Swal.fire({
          title: "Loading",
          html: "Loading...",
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        db.ref("mod")
          .orderByChild("timestamp")
          .once("value", (snapshot) => {
            infoContainer.innerHTML = "";
            const sortedEntries = [];
            snapshot.forEach((childSnapshot) => {
              sortedEntries.unshift(childSnapshot.val());
            });
            sortedEntries.forEach((info) => {
              const div = document.createElement("div");
              const date = new Date(info.timestamp);
              const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
              div.innerHTML = `<strong>Name:</strong> ${info.name}<br>
                           <strong>Suggested Rank:</strong> ${info.suggestedRank}<br>
                           <strong>Detail:</strong> ${info.detail}<br>
                           <strong>User ID:</strong> ${info.userId}<br>
                           <strong>IP:</strong> ${info.ip}<br>
                           <strong>Time:</strong> ${formattedDate}<br><br>`;

              if (userEmail === "sidamailbox@gmail.com") {
                div.innerHTML += `<button class="approveButton" onclick="approveInfo('${info.userId}', '${info.timestamp}')">Approve</button>
                                  <button class="disapproveButton" onclick="disapproveInfo('${info.userId}', '${info.timestamp}')">Disapprove</button><br><br>`;
              }

              db.ref(`approvals/${info.userId}/${info.timestamp}`).once('value', (approvalSnapshot) => {
                const approvalData = approvalSnapshot.val();
                if (approvalData) {
                  div.innerHTML += `<strong>Status:</strong> <span class="${approvalData.status === 'approved' ? 'approved' : 'disapproved'}">${approvalData.status}</span><br><br>`;
                }
              });

              infoContainer.appendChild(div);
            });
            Swal.close();
          });
      });
    }

    function approveInfo(userId, timestamp) {
      db.ref(`approvals/${userId}/${timestamp}`).set({
        status: 'approved',
        approvedBy: userId,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
      }).then(() => {
        readInfo();
      });
    }

    function disapproveInfo(userId, timestamp) {
      db.ref(`approvals/${userId}/${timestamp}`).set({
        status: 'disapproved',
        approvedBy: userId,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
      }).then(() => {
        readInfo();
      });
    }

    function refreshPage() {
      location.reload();
    }

    function refreshInfoContainer() {
      readInfo();
    }

    function goToHome() {
      location.href = "https://foursquare-leaderboard.web.app";
    }

    function openChat() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        Swal.fire({
          title: "Chat",
          html: `
            <div id="chatContainer"></div>
            <input type="text" id="chatInput" placeholder="Type a message" class="swal2-input" style="margin-top: 10px;">
            <div style="text-align: left; font-size: 12px; padding-left: 10px; margin-top: 12px;">Press Enter to send, click outside of the window to close.</div>
          `,
          focusConfirm: false,
          showCancelButton: true,
          showConfirmButton: false,
          didOpen: () => {
            const chatContainer = document.getElementById("chatContainer");
            chatContainer.scrollTop = chatContainer.scrollHeight;
            document.getElementById("chatInput").addEventListener("keypress", (event) => {
              if (event.key === "Enter") {
                sendMessage();
              }
            });
            refreshChat();
            setInterval(refreshChat, 1000);
          },
          willClose: () => {
            clearInterval(refreshChat);
          },
          customClass: {
            container: 'chat-swal2-modal'
          }
        });
      });
    }

    function sendMessage() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        const message = document.getElementById("chatInput").value.trim();
        if (message !== "") {
          db.ref("chat")
            .push({
              message: message,
              userId: userId,
              userName: userName,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
            })
            .then(() => {
              document.getElementById("chatInput").value = "";
            });
        }
      });
    }

    function refreshChat() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        const chatContainer = document.getElementById("chatContainer");
        db.ref("chat")
          .orderByChild("timestamp")
          .once("value", (snapshot) => {
            chatContainer.innerHTML = "";
            const chatMessages = [];
            snapshot.forEach((childSnapshot) => {
              chatMessages.push(childSnapshot.val());
            });
            chatMessages.forEach((chatData) => {
              const messageDiv = document.createElement("div");
              messageDiv.classList.add("chatMessage");
              const formattedDate = new Date(
                chatData.timestamp
              ).toLocaleString();
              messageDiv.innerText = `${formattedDate}, ${chatData.userName}: ${chatData.message}`;
              chatContainer.appendChild(messageDiv);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
          });
      });
    }

    function openIpBanForm() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        Swal.fire({
          title: 'Ban User',
          html: `
            <label for="userSelect">Select User:</label>
            <select id="userSelect" class="swal2-input">
              <!-- Options will be populated dynamically -->
            </select>
            <label for="banType">Select Ban Type:</label>
            <select id="banType" class="swal2-input">
              <option value="permanent">Permanent</option>
              <option value="time">24 Hour</option>
            </select>
            <label for="banReason">Reason:</label>
            <input type="text" id="banReason" class="swal2-input" placeholder="Enter reason">

            Only Admins may unban users. This action WILL be logged.
          `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'Send',
          preConfirm: () => {
            const userId = document.getElementById('userSelect').value;
            const banType = document.getElementById('banType').value;
            const banReason = document.getElementById('banReason').value;
            if (!userId || !banReason) {
              Swal.showValidationMessage('Please select a user and enter a reason');
              return false;
            }
            return { userId, banType, banReason };
          },
          customClass: {
            container: 'ip-ban-swal2-modal'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const { userId, banType, banReason } = result.value;
            if (userId === "o548WLH1w3Qh0S2Yng5RtPYZWtS2") {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'You cannot ban Silas',
              });
              return;
            }
            banUser(userId, banType, banReason);
          }
        });

        // Populate user options
        db.ref('users').once('value', (snapshot) => {
          const userSelect = document.getElementById('userSelect');
          snapshot.forEach((userSnapshot) => {
            const userData = userSnapshot.val();
            const option = document.createElement('option');
            option.value = userSnapshot.key;
            option.text = `${userData.name} (${userData.email})`;
            userSelect.appendChild(option);
          });
        });
      });
    }

    function banUser(userId, banType, banReason) {
      const banData = {
        unbanTime: banType === 'permanent' ? 89898989898989900000 : new Date().getTime() + 86400000
      };

      const logData = {
        time: new Date().toISOString(),
        bannedUserId: userId,
        moderatorName: userName,
        reason: banReason,
      };

      const updates = {};
      updates[`banned/${userId}`] = banData;
      updates[`banLogs/${userId}`] = logData;

      return db.ref().update(updates)
        .then(() => {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'User has been banned successfully.',
            confirmButtonText: 'Close',
            customClass: {
              container: 'ban-success-swal2-modal'
            }
          });
        })
        .catch((error) => {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `Failed to ban user: ${error.message}`,
            customClass: {
              container: 'ban-error-swal2-modal'
            }
          });
        });
    }

    function checkIpBan(ip) {
      const formattedIp = ip.replace(/\./g, '_');
      return db.ref(`banned/${formattedIp}`).once('value')
        .then((snapshot) => {
          const banData = snapshot.val();
          if (banData && banData.unbanTime > new Date().getTime()) {
            return true;
          }
          return false;
        });
    }

    function openUsers() {
      if (!validateModeratorStatus()) return;
      checkIpBan(userIp).then(isBanned => {
        if (isBanned) return;

        Swal.fire({
          title: 'Users',
          html: `
            <input type="text" id="searchInput" placeholder="Search by name or email" class="swal2-input" style="margin-bottom: 10px;">
            <div id="usersTableContainer"></div>
          `,
          showCloseButton: true,
          didOpen: () => {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', () => {
              fetchUsers(searchInput.value);
            });
            fetchUsers();
          },
          customClass: {
            container: 'users-swal2-modal'
          }
        });
      });
    }

    function fetchUsers(searchQuery = '') {
      const usersTableContainer = document.getElementById('usersTableContainer');
      db.ref('users')
        .on('value', (snapshot) => {
          usersTableContainer.innerHTML = '';
          snapshot.forEach((userSnapshot) => {
            const userData = userSnapshot.val();
            if (searchQuery && !(userData.name.includes(searchQuery) || userData.email.includes(searchQuery))) {
              return;
            }
            const userDiv = document.createElement('div');
            userDiv.classList.add('userRow');
            userDiv.innerHTML = `
              <table style="width:100%">
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Banned</th>
                  <th>Actions</th>
                </tr>
                <tr>
                  <td>${userData.name}</td>
                  <td>${userData.email}</td>
                  <td id="banStatus_${userSnapshot.key}">Loading...</td>
                  <td><button onclick="showUserActions('${userSnapshot.key}')">More Details</button></td>
                </tr>
              </table>
              <hr>`;
            usersTableContainer.appendChild(userDiv);

            // Check if the user is banned
            db.ref(`banned/${userSnapshot.key}`).once('value')
              .then((banSnapshot) => {
                const banData = banSnapshot.val();
                const banStatusCell = document.getElementById(`banStatus_${userSnapshot.key}`);
                if (banData && banData.unbanTime > new Date().getTime()) {
                  banStatusCell.innerText = 'Yes';
                } else {
                  banStatusCell.innerText = 'No';
                }
              });
          });
        });
    }

    function showUserActions(userId) {
      Swal.fire({
        title: 'User Actions',
        html: `
          <div id="actionsTableContainer"></div>
        `,
        showCloseButton: true,
        didOpen: () => {
          fetchUserActions(userId);
        },
        customClass: {
          container: 'users-swal2-modal'
        }
      });
    }

    function fetchUserActions(userId) {
      const actionsTableContainer = document.getElementById('actionsTableContainer');
      db.ref(`actions/${userId}`)
        .on('value', (snapshot) => {
          actionsTableContainer.innerHTML = '';
          const actionsTable = document.createElement('table');
          actionsTable.style.width = '100%';
          actionsTable.innerHTML = `
            <tr>
              <th>Action</th>
              <th>Timestamp</th>
              <th>Details</th>
            </tr>
          `;
          snapshot.forEach((actionSnapshot) => {
            const actionData = actionSnapshot.val();
            const actionRow = document.createElement('tr');
            actionRow.innerHTML = `
              <td>${actionData.action}</td>
              <td>${new Date(actionData.timestamp).toLocaleString()}</td>
              <td><button onclick="showActionDetails('${actionSnapshot.key}', '${userId}')">More Details</button></td>
            `;
            actionsTable.appendChild(actionRow);
          });
          actionsTableContainer.appendChild(actionsTable);
        });
    }

    function showActionDetails(actionKey, userId) {
      Swal.fire({
        title: 'Action Details',
        html: `
          <div id="actionDetailsContainer"></div>
        `,
        showCloseButton: true,
        didOpen: () => {
          fetchActionDetails(actionKey, userId);
        },
        customClass: {
          container: 'users-swal2-modal'
        }
      });
    }

    function fetchActionDetails(actionKey, userId) {
      const actionDetailsContainer = document.getElementById('actionDetailsContainer');
      db.ref(`actions/${userId}/${actionKey}/details`)
        .once('value', (snapshot) => {
          const details = snapshot.val();
          actionDetailsContainer.innerHTML = `
            <pre>${JSON.stringify(details, null, 2)}</pre>
          `;
        });
    }

    function validateModeratorStatus() {
      if (!userId) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "You are not a moderator.",
        });
        return false;
      }
      return true;
    }

    window.onload = loadPage;
  </script>

  <div id="dashboard" style="display: none">
    <h1>Foursquare Leaderboard Moderator Dashboard</h1>
    <div>
      <label id="userIdDisplay"></label><br />
      <label id="dateTimeDisplay"></label><br /><br />
      <label for="name">Name of Detail:</label><br />
      <input type="text" id="name" name="name" /><br />
      <label for="suggestedRank">Suggested Rank:</label><br />
      <input type="text" id="suggestedRank" name="suggestedRank" /><br />
      <label for="detail">Detail:</label><br />
      <textarea id="detail" name="detail" rows="4"></textarea><br />
      <button onclick="sendInfo()">Send</button>
      <button onclick="refreshPage()">Logout</button>
      <button onclick="goToHome()">Home</button>
      <button onclick="openChat()">Chat</button>
      <button onclick="openIpBanForm()">Ban</button>
      <button onclick="openUsers()">Users</button>
      <button class="refreshButton" onclick="refreshInfoContainer()">Refresh Info</button>
    </div>
    <hr />
    <h5>Abuse of your privileges will get your moderator status removed.</h5>
    <h2>Existing Info:</h2>
    <div id="infoContainer"></div>
  </div>
</body>
</html>
